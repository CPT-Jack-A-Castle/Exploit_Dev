# MS15-011 

## Vuln Description
 On a vulnerable version of Windows that is joined to a domain when a GPO update occurs the identity of the Domain Controller is not validated properly which allows attackers to manipulate registry keys, which can lead to remote code execution. An attacker can perform man-in-the-middle attacks and forward SMB traffic to their own SMB server, the target machine will accept these files thinking they are from the domain controller, then complete the GPO updates from files on the SMB server generated in by this exploit script. By default the SMB network client of systems is set to *OFF*, if a sysadmin has enabled SMB signing on the network client MS15-014 will need to be exploited first before MS15-011 can be exploited.

For a in-depth explanation of the vulnerabilities and exploit scenarios refer to the F-Secure and ADSecurity links below in the References section.

## Attacks
Numerous attacks are possible through this exploit, some high-value attacks scenarios include:
* Set various persistence registry keys to achieve code execution such as: AppInit_DLL, Run and RunOnce
* AppInit_DLL runs as SYSTEM and can use a remote file hosted on an attackers SMB server
* Run key values can use RunDll32.exe to run a DLL hosted on an attackers SMB server to run the executable in memory.
* Disable SMB Signing for relay attacks


## Exploitation - What the script does
By default, GPO updates occur every 90 minutes plus a random amount of time between 0 and 30 minutes. This means exploitation could take up to 120 minutes (2 hours) with default settings. Depending on the environment it is possible updates have modified to update more frequently, it is also possible updates may occur much less frequently. 

This exploit will:
* Download required files from git repo: gpt.ini, GptTmpl.inf, GptTmpl.inf.bak, KarmaSMB.py
* ArpSpoof a target and the domain controller(s). 
* Generate x64 meterpreter reverse shell DLL and a metasploit resource file for easy listener configuration
* iptables to forward SMB traffic to SMB server
* Run KarmaSMB server
* KarmaSMB will serve gpt.ini, GptTmpl.inf and the generated DLL file 
* *Note* Read about KarmaSMB for more info https://github.com/SecureAuthCorp/impacket/blob/master/examples/karmaSMB.py

### Here's a GIF showing the exploit 

![alt text](https://github.com/Freakazoidile/Exploit_Dev/blob/master/MS15-011/MS15-011.gif "Exploit in Action GIF")

## Caveats
The shell from AppInit_DLL is unstable. A raw shell did not work, meterpreter did. x32 payloads did not work on x64 systems, I have not tested anything on x32 systems, only x64. @freakazoidile on twitter or hit up the issues to let me know if you test on x32 systems and what payload works.

AppInit DLL is called each time User32.dll is loaded, which is almost every time a new process with a UI is started. This means it will be called a huge number of times, during testing SMB calls to download the file specified in the AppInit DLL key exceeded a rate of 100 per minute. 

Once two or three shells are received, I typically kill the exploit, then quickly set the AppInit DLL key to a blank value in meterpreter. If you leave the registry key pointing to your payload the shell will be slow, unstable and often starts spawning multiple Windows message boxes that something failed. I recommend establishing persistence by adding a local admin (you're running as SYSTEM) as the first step after getting a shell.

Using generic reverse_tcp resulted in a connection but instantly failed. Using meterpreter payloads were significantly better but not without issues. Many of meterpreter's features will not work, take multiple tries or take longer than normal. The following features  resulted in a session dying numerous times, use at your own risk:
* Migrate processes
* Spawn process
* Download/upload files
* Screenshot
* Many "Post" modules such as VNC

Modules that worked without issue during my testing:
* `Reg` command to interact with registry
* `Execute` to add a user without dropping into shell. Dropping into shell was slow, and a few times unstable
* `incognito` module for impersonating domain users then adding domain admins (if tokens and permissions were there)

### Fun Fact
The maximum GPO update time is 31 days with a maximum additional random time of 24 hours. If a sysadmin has configured for the maximum limits and has hardened the system by enabling SMB signing for the network client MS15-014 will need to be exploited and then MS15-011, which in theory could take up to 62 days to exploit. Have fun waiting for that shell!

![alt text](https://github.com/Freakazoidile/Exploit_Dev/blob/master/MS15-011/still%20waiting.jpg "Waiting for Shell")


## Example Usage
Example command where 172.66.10.2 is the vulnerable target machine and 172.66.10.10 is the DC. Multiple DC's are supported

`python3 ms15-011.py -t 172.66.10.2 -d 172.66.10.10 -i eth1`

Multiple DC's:

`python3 ms15-011.py -t 172.66.10.2 -d 172.66.10.10 -d 172.66.10.11 -d 172.66.10.12 -i eth1`

*Note* See Requirements below. This script makes changes to iptables PREROUTING and POSTROUTING NAT table and enables IP_forwarding. Make sure to revert settings after exploitation.


## Requirements
* ArpSpoof
* iptables
* Impacket
* Git
* Files from this Repo: KarmaSMB.py, GptTmpl.inf, GptTmpl.inf.bak, gpt.ini
* Python3 and w/e libraries are imported.

## Additional Notes
* This script does not work if Kerberos is required, exploitation is possible but I won't be scripting that. The F-Secure link below mentions the steps required for exploitation if Kerberos is in use, it requires additional effort to exploit including password cracking of kerberos tickets, or knowledge of user passwords.
* If you want to target multiple hosts you can either modify the script or run additional ArpSpoof commands.


## References
https://docs.microsoft.com/en-us/security-updates/securitybulletins/2015/ms15-011

https://labs.f-secure.com/archive/how-to-own-any-windows-network-with-group-policy-hijacking-attacks/

https://adsecurity.org/?p=1405
